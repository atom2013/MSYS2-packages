build:
  image: teaci/msys$$WIDTH
  pull: true
  shell: msys$$WIDTH
  commands:
    # TODO: remove this option when not anymore needed
    - if [ $$WIDTH = 32 ]; then
    - export DISABLE_QUALITY_CHECK=true;
    - export ARCH=i686
    - else
    - export ARCH=x86_64
    - fi
    - eval export DISTRIB_FILE_URL=${DISTRIB_FILE_URL}
    - eval export DISTRIB_FILE_NAME=${DISTRIB_FILE_NAME}
    - if [ -d msys$$WIDTH-build ]; then
    - mv -vf msys$$WIDTH-build /c/
    - fi
    - cmd /C "install.cmd"
    - cmd /C "C:\\msys$$WIDTH-build\\usr\\bin\\bash --login -c \"$(cygpath -m ${DRONE_DIR})/ci-build.sh BUILD\""
    - cmd /C "C:\\msys$$WIDTH-build\\usr\\bin\\bash --login -c \"$(cygpath -m ${DRONE_DIR})/ci-build.sh DISTRIB\""
    - cmd /C "C:\\msys$$WIDTH-build\\usr\\bin\\bash --login -c \"$(cygpath -m ${DRONE_DIR})/ci-build.sh DEPLOY\""
    - cmd /C "C:\\msys$$WIDTH-build\\usr\\bin\\bash --login -c \"$(cygpath -m ${DRONE_DIR})/ci-build.sh CACHE\""
    - mv -vf /c/msys$$WIDTH-build ./
  environment:
    - WIDTH=$$WIDTH
    - PRIVATE_KEY=$$PRIVATE_KEY
    - DEPLOY_PROVIDER=bintray
    - BINTRAY_ACCOUNT=atomlong
    - BINTRAY_REPOSITORY=msys2
    - BINTRAY_API_KEY=$$BINTRAY_API_KEY
    - BINTRAY_VERSION=latest
    - PACMAN_REPOSITORY_NAME=msys
    - DISTRIB_PACKAGE_NAME=distrib
    - GPG_KEY_PASSWD=$$GPG_KEY_PASSWD
    - GPG_FILE_SECRET=$$GPG_FILE_SECRET
    - MSYS2_ROOT=C:\msys-install\msys$$WIDTH
    - DISTRIB_FILE_URL=https://dl.bintray.com/${BINTRAY_ACCOUNT}/${BINTRAY_REPOSITORY}/${DISTRIB_PACKAGE_NAME}/${ARCH}/msys2-base-${ARCH}-latest.tar.xz
    - DISTRIB_FILE_NAME=msys2-base-${ARCH}-latest.tar.xz

cache:
  mount:
    - msys$$WIDTH-build

notify:
  email:
    from: atom.long@hotmail.com
    host: smtp-mail.outlook.com
    port: 587
    username: atom.long@hotmail.com
    password: $$MAIL_SECRET
    recipients:
      - atom.long@hotmail.com

matrix:
  WIDTH:
    # At present, I don't use the x86_64 target.
    # - 64
    - 32
